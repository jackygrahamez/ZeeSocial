<% include header %>

<section class="content">
    <header class="content-header">
        <h1 class="light no-margin"><%= user.name.first %> <%= user.name.last %></h1>
		<h2 class="light no-margin">Message</h2>
    </header>
    <section class="bordered">
		<form method="post" action="/<%= user.username %>/user_message/" class="form-skin">
			<fieldset>
			  <label>Post a message:</label>
			  <label>Check-in ID: </label>
			  <input id="cID" type="text" name="cID" value="<%= tID %>" />
			  <label>To: </label>
			  <input id="tID" type="text" name="tID" value="<%= tID %>" />
			  <label>From: </label>
			  <input id="fID" type="text" name="fID" value="<%= fID %>" />
			  <textarea id="message" name="message" rows="4" cols="50"></textarea>
			</fieldset>						
			<p>
			  <input id="post" type="button" value="Post Message" class="btn btn-flat btn-blue no-radius"/>
			</p>
		</form>
	
		<ul>
		<% for(var i=0; i<message_doc[0].thread.length; i++) {%>
		<li index="<% message_doc[0].thread[i].counter %>">
			<%= message_doc[i].username %>: <%= message_doc[0].thread[i].message %> 
			<label>Time: </label>
			<input id="time_<%= i %>" type="text" name="time" value="<%= message_doc[0].thread[i].time %>" />
			<label>counter: </label>
			<input class="counter" id="counter_<%= i %>" type="text" name="counter" value="<%= message_doc[0].thread[i].counter %>" />			
		</li>
		<% } %>
		</ul>

    </section>
</section>

<% include footer %>

  <script type="text/javascript">
	var message_counter;

	var markup;
	counter = $(".counter").last().val
	  $("body, input, textarea").keypress(function(e){
	  		console.log("key pressed");
	        if(e.which==13) {
			var messageString = $("#message").val(),
				cIDString = $("#cID").val(),
				tIDString = $("#tID").val(),
				fIDString = $("#fID").val();
			console.log("tIDString "+tIDString);			
			console.log("fIDString "+fIDString);
			postMessage(messageString, cIDString, tIDString, fIDString);
			$("#message").val("");	        
	        }
	   });	
      $('#post').click(function(){ 
      	console.log("post clicked"); 
		var messageString = $("#message").val(),
			cIDString = $("#cID").val(),
			tIDString = $("#tID").val(),
			fIDString = $("#fID").val();
		console.log("tIDString "+tIDString);			
		console.log("fIDString "+fIDString);
		message_counter = $("ul li").last().attr("index");
		console.log("message_counter "+message_counter);		
		postMessage(messageString, cIDString, tIDString, fIDString);
     });
     
     function postMessage(messageString, cIDString, tIDString, fIDString) {
		if((messageString.length > 0) && (cIDString.length > 0) && (tIDString.length > 0) && (fIDString.length > 0)) {

			if (!message_counter) {
				message_counter = 0; 
			}		
		     $.ajax({ 
		           url: '/<%= user.username %>/user_message/',
		           type: 'POST',
		           cache: false, 
		           data: { message: messageString, cID: cIDString, tID: tIDString, fID: fIDString, counter: message_counter }, 
		           success: function(data){
		           	  markup = data;
		              //alert('Success!');
		              $("section ul").append(data);
		              
		           }
		           , error: function(jqXHR, textStatus, err){
		               alert('text status '+textStatus+', err '+err)
		           }
		        });
		}     
     }            

  </script>